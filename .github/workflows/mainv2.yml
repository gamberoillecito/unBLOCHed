name: Build & Deploy (main -> Pages, development -> unBLOCHed-beta)

on:
  push:
    branches: [main, development]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: site-build
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 9

      - name: Install Node.js
        uses: actions/setup-node@v4.2.0
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Set BASE_PATH based on branch
        run: |
          if [ "${GITHUB_REF#refs/heads/}" = "main" ]; then
            echo "BASE_PATH=/${{ github.event.repository.name }}" >> $GITHUB_ENV
            export BASE_PATH=/${{ github.event.repository.name }}
          else
            # for development deploy target repo path 
            echo "BASE_PATH=/unBLOCHed-beta" >> $GITHUB_ENV
            export BASE_PATH=/unBLOCHed-beta
          fi
          echo "BASE_PATH set to: $BASE_PATH"

      - name: Build
        env:
          BASE_PATH: ${{ env.BASE_PATH }}
          VITE_BASE: ${{ env.BASE_PATH }}
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            pnpm run build
          else
            pnpm run build --mode beta
          fi

      - name: Debug build output
        run: |
          echo "ENV: BASE_PATH='${BASE_PATH}' VITE_BASE='${VITE_BASE}'"
          echo "Top-level build files:"
          ls -la build | sed -n '1,200p'
          echo "Show build/index.html head (first 200 lines):"
          head -n 200 build/index.html || true
          echo "List _app contents (if present):"
          ls -la build/_app || true
          echo "Search for BASE_PATH occurrences in build:"
          grep -R --line-number "${BASE_PATH#/}" build || true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: build/

  deploy-pages:
    name: Deploy to GitHub Pages (main)
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: build

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          static_site_generator: sveltekit

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'build/'

  deploy-beta:
    name: Push build to unBLOCHed-beta (development)
    needs: build
    if: github.ref == 'refs/heads/development'
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: build

      - name: Checkout target repo (unBLOCHed-beta)
        uses: actions/checkout@v5
        with:
          repository: ${{ github.repository_owner }}/unBLOCHed-beta
          token: ${{ secrets.DEPLOY_TOKEN }}
          path: target-repo
          fetch-depth: 0

      - name: Debug target-repo files
        run: |
          echo "Listing target-repo top-level"
          ls -la target-repo
          echo "List _app"
          ls -la target-repo/_app || true
          echo "Show index.html head"
          head -n 40 target-repo/index.html || true

      - name: Ensure .nojekyll in target repo
        run: |
          # create marker so GitHub Pages won't filter _* files
          touch target-repo/.nojekyll
          ls -la target-repo | sed -n '1,120p'

      - name: Sync built files into target repo
        run: |
          cd target-repo
          # Remove only the old build files, keep config and git
          rm -rf _app *.html *.css *.js *.json || true
          rm -rf .github || true

          # Copy new build files
          cp -a ../build/. .

          # Ensure .nojekyll exists
          touch .nojekyll

          git add --all
          git -c user.name="github-actions[bot]" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" commit -m "Site update from ${GITHUB_SHA} (development)" || echo "No changes to commit"

      - name: Push to target repo
        run: |
          cd target-repo
          git push --force-with-lease origin HEAD:main
        env:
          GIT_ASKPASS: /bin/true
